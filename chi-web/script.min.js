(function(m){var h="../chi-v2/data.xml";var q="../chi-v2/stage.txt";var j=$("#wc-stageselected .text");var e=$("#wc-stagelist");var i=$("#wc-searchBtn");var t=$("#wc-searchresult");var l=$("#wc-searchloading");var r=$("#wc-requestInput");var s=$("#wc-requestBtn");var o=$("#wc-loading");var g=$("#wc-retry");var f=$("#wc-content");var d=null;var n=null;var b=null;var u=null;function p(){g.addClass("hide");o.removeClass("hide");d=null;n=null;$.ajax({url:h,cache:false,dataType:"text",success:function(v){d=$(v);c()},fail:function(v){g.removeClass("hide")}});$.ajax({url:q,cache:false,dataType:"text",success:function(z){var w=z.split(/[\r\n]+/);var A=true;var y=null;n=[];for(var x=0;x<w.length;x++){var v=w[x].trim();if(v==""){continue}if(v.indexOf("---")>=0){n.push([v.replace(/^---|---$/g,""),false]);continue}if(A){y=v}else{n.push([y,true])}A=!A}c()},fail:function(v){g.removeClass("hide")}})}function c(){if(d==null||n==null){return}o.addClass("hide");f.removeClass("hide");e.empty();var v=true;$.each(n,function(z,y){var w=!y[1];var A=y[0];var x;if(w){x=$("<li>").addClass("dropdown-header").attr("role","presentation").text(A).click(function(){return false})}else{if(v){v=false;j.text(A)}x=$("<li>").append($('<a href="#"></a>').text(A)).click(function(){j.text($(this).text());b=null})}x.appendTo(e)})}function k(v){return btoa(unescape(encodeURIComponent(v))).replace(/=+$/,"")}m.searchTeam=function(){var x=j.text();var v=k(x);var y=d.find("api").text()+"/v2/team/"+v;l.removeClass("hide");t.addClass("hide");i.addClass("disabled");var w=b;setTimeout(w===null?function(){$.post(y,function(z){a(x,z)})}:function(){console.log("using cache");a(w.stage,w.codeBase64)},300)};function a(w,C){t.empty();var z=atob(C);for(var x=0;x<z.length;x+=3){var B=z.charCodeAt(x);var A=z.charCodeAt(x+1);var y=z.charCodeAt(x+2);var v="0000"+(B*65536+A*256+y);$('<li class="list-group-item"></li>').text(v.substring(v.length-5)).appendTo(t)}l.addClass("hide");t.removeClass("hide");i.removeClass("disabled");b={stage:w,codeBase64:C};if(u!=null){clearTimeout(u)}u=setTimeout(function(){b=null},2000)}m.requestTeam=function(){var A=r.val();if(!/\d{5}/.test(A)){alert("請輸入５位數字的房間號碼。");return}s.addClass("disabled").text("發送中...");var z=10;var v=function(){if(z==0){s.removeClass("disabled").text("募集")}else{s.text("發送完成 ("+z+")");z--;setTimeout(v,1000)}};var x=j.text();var w=k(x);var y=d.find("api").text()+"/v2/team/"+w+"/"+A;$.post(y,function(B){v()})};$(p)})(top);